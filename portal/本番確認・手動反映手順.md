Up: [[00_INDEX]]

# 本番確認・手動反映手順

## ⚡ 今日の進め方（クイック参照）

1. **本番HTMLの修正** → Internal_DX_Portal 内の該当 HTML を Cursor で編集 → プレビューで確認 → **デプロイ**（下記「選択肢 B」がおすすめ）
2. **本番反映が終わったら** → 資料を読み直しながら資料の修正

---

## 📌 前提の整理

- **「本番環境のHTMLを修正」** = ローカルで HTML を編集し、その変更を **GAS の本番 Web アプリ** に反映すること。
- 本番の HTML を直接触るのではなく、**Internal_DX_Portal** のローカルファイルを直してから **デプロイ** する流れです。

---

## ⚠️ GAS の制約：バージョン200件まで・本番反映は毎回時間がかかる

### 困っていること
- **GAS はバージョン履歴が 200 件まで**。超えるとエラーになる。
- 編集はローカルで HTML を作るから問題ないが、**本番に上げるたびに** `deploy_now.ps1`（push → version → redeploy）を回すと、
  - **1回ごとにバージョンが 1 つ消費される** → 200 にすぐ近づく
  - **2〜5 分かかる** → 毎回やると時間が何倍もかかる

### 対策：「確認用」と「本番反映」を分ける

| 用途 | やること | 時間 | バージョン消費 |
|------|----------|------|----------------|
| **確認用**（日常） | `.\push_only.ps1` だけで push。**テスト用URL**で見る | 数十秒〜1分 | **しない** |
| **本番反映**（区切りがいいときだけ） | `.\deploy_now.ps1`（push ＋ version ＋ redeploy） | 2〜5分 | **1件** |

- **日常**：編集 → `push_only.ps1` → **テスト用URL**で「ちゃんと反映されてるか」だけ確認。バージョンは作らないので 200 に近づかないし、時間も短い。
- **本番に上げる**：「今日の修正をまとめて反映する」「週に1回」など、**区切りがついたときだけ** `deploy_now.ps1` を実行する。

こうすると、**本番に上げる回数が減る** → かける時間も減るし、200 バージョンにも届きにくくなる。

### テスト用URL（確認用）の用意

**初回だけ**、GAS 側で「テスト用」の Web アプリデプロイを 1 つ作っておく。

1. GAS のプロジェクトを開く（`clasp open` でブラウザが開く）
2. **デプロイ** → **デプロイを管理**
3. **デプロイを追加** → 種類「ウェブアプリ」→ 説明「Test」など
4. **バージョン**で **「テスト」または「HEAD」**（常に最新のコード）を選ぶ → **デプロイ**
5. 表示された **ウェブアプリの URL** を控える → これが「確認用URL」

以降、ローカルで編集して `.\push_only.ps1` を実行したあと、この URL を開けば **push した直後の内容** がすぐ確認できる（バージョンは作らない）。

---

## 🎯 今日の進め方（本番HTML → 資料修正）

1. **まず本番HTMLの修正**
   - 該当する `.html` を Internal_DX_Portal 内で編集
   - ローカルプレビューで見た目・リンクを確認
   - 問題なければ **本番に反映**（下記「デプロイのやり方」を参照）

2. **本番反映が完了したら資料の修正**
   - 資料を読み直しながら、文言・構成・図の修正を行う

---

## 📂 本番反映の流れ（確認用 vs 本番）

| 段階 | やること | どこで |
|------|----------|--------|
| ① 編集 | HTML を直す | Cursor（Internal_DX_Portal 内のファイル） |
| ② 確認 | ローカルでプレビュー | `.\dev_preview.ps1` または `.\preview.ps1 xxx.html` |
| ③a 確認用（日常） | GAS に送ってテスト用URLで見るだけ | `.\push_only.ps1` → **テスト用URL**で確認（バージョン消費なし・数十秒〜1分） |
| ③b 本番反映（区切りがいいとき） | 本番の Web アプリを更新 | `.\deploy_now.ps1`（2〜5分・バージョン1件消費） |

※ リンクは `<?=url?>?page=xxx` 形式のまま書いておく。プレビュー時にローカル用に変換される。

---

## 🚀 デプロイのやり方（Cursorが苦手な場合の選択肢）

本番の「既存 Web アプリ」を更新するには、次の一連の操作が必要です。

- `clasp push -f`（GAS にコードを送る）
- `clasp version "説明"`（新バージョン作成）
- `clasp redeploy -V バージョン番号 -d auto デプロイID`（そのバージョンを本番に当てる）

これをまとめて実行するスクリプトが **`deploy_now.ps1`** です。

### 選択肢 A: Cursor のターミナルで実行する

**条件**
- ターミナルのカレントディレクトリが **`Internal_DX_Portal`** であること
- PowerShell で実行すること
- 事前に `clasp login` 済みであること

**手順**

1. Cursor でワークスペースを開いた状態で、ターミナルを開く。
2. `Internal_DX_Portal` に移動してから実行する。

```powershell
cd "c:\Users\toru.tanji\Documents\SecondBrain_Final\Internal_DX_Portal"
.\deploy_now.ps1
```

3. 2〜5 分ほどかかることがあります。最後に「デプロイ完了 (version XX)」と出れば、本番URLで確認してください。

**Cursor でうまくいかない場合によくある理由**
- ターミナルのカレントが `SecondBrain_Final` のままで、`Internal_DX_Portal` になっていない
- `npm` / `node` が Cursor のターミナルから見えていない（別の PATH になっている）
- PowerShell の実行ポリシーで `.\deploy_now.ps1` がブロックされている

---

### 選択肢 B: Cursor の外でデプロイする（おすすめ）

Cursor のターミナルからデプロイしづらい場合は、**Cursor では編集だけし、デプロイは別の PowerShell で行う**やり方が確実です。

1. **Cursor**  
   - Internal_DX_Portal 内の HTML を編集  
   - 編集が終わったら保存するだけ（デプロイはしない）

2. **エクスプローラー**  
   - `SecondBrain_Final\Internal_DX_Portal` を開く  
   - アドレス欄に `powershell` と入力して Enter  
   - そのフォルダで PowerShell が開く

3. **PowerShell でデプロイ**

```powershell
.\deploy_now.ps1
```

4. 完了メッセージを確認し、本番の Web アプリ URL で表示を確認する。

**ポイント**
- 「HTML を直す」のと「本番に反映する」を **Cursor と PowerShell で分離** すると、Cursor がデプロイに不向きでも進めやすい。
- 編集は Cursor、反映は同じマシンの別 PowerShell、という役割分担にすると悩みが減ります。

---

### 選択肢 C: clasp を手動で叩く

`deploy_now.ps1` が動かない環境の場合の代替です。**必ず `Internal_DX_Portal` で** 以下を実行してください。

```powershell
cd "c:\Users\toru.tanji\Documents\SecondBrain_Final\Internal_DX_Portal"

# 1. GAS に push
npx --yes @google/clasp push -f

# 2. バージョン作成（説明は日時などで可）
npx --yes @google/clasp version "manual-20260128"

# 3. 表示されたバージョン番号（例: 42）を使って redeploy
# deploy_config.json の deploymentId を使う
npx --yes @google/clasp redeploy -V 42 -d auto "AKfycbzubD24U27_X6_SREm4vqrPl5fVs8fmzvW1pGjaKXzyV1lJ_cVv66akCpvwEJHXO71XFQ"
```

`deploy_config.json` の `deploymentId` はそのまま使ってください。

---

## ✅ 本番反映後の確認

- 本番の Web アプリ URL を開く
- 直したページに遷移し、文言・リンク・表示が意図どおりか確認する

---

## 📋 よく使うコマンド一覧（参照）

| 目的 | コマンド |
|------|----------|
| ローカルで全ページ確認 | `.\dev_preview.ps1`（要: Internal_DX_Portal がカレント） |
| 単一 HTML だけ確認 | `.\preview.ps1 ファイル名.html` |
| **確認用**：GAS に送ってテスト用URLで見る（バージョン消費なし・短時間） | `.\push_only.ps1` |
| **本番反映**：本番の Web アプリを更新（2〜5分・バージョン1件消費） | `.\deploy_now.ps1` |
| clasp ログイン確認 | `npx --yes @google/clasp login --status` |

---

## 🔗 関連

- [[README_LOCAL_WORKFLOW]]：ローカルでの編集・プレビュー・リンクの書き方
- [[README_CLASP]]：clasp の前提条件と基本操作
